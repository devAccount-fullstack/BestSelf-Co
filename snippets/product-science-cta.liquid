{% comment %}
  Product CTA block for Science pages with Add to Cart functionality
  
  Accepts:
  - product: Product object
  - block: Block settings
  - animation_anchor: Animation anchor ID
{% endcomment %}

{%- liquid
  assign product = all_products[block.settings.product]
  
  if product == blank
    assign product = page.metafields.custom.product_spotlight.value
  endif
  
  if product != blank
    assign current_variant = product.selected_or_first_available_variant
    assign product_form_id = 'product-form-' | append: section.id | append: '-' | append: block.id
  endif
-%}

{%- if product != blank -%}
  <div class="product-science-cta">
    {%- comment -%}Product Image{%- endcomment -%}
    {%- if product.featured_image != blank -%}
      <div class="product-science-cta__image">
        <img
          src="{{ product.featured_image | image_url: width: 600 }}"
          srcset="{{ product.featured_image | image_url: width: 300 }} 300w,
                  {{ product.featured_image | image_url: width: 600 }} 600w,
                  {{ product.featured_image | image_url: width: 900 }} 900w"
          sizes="(max-width: 749px) 100vw, 50vw"
          alt="{{ product.featured_image.alt | default: product.title | escape }}"
          loading="lazy"
          width="{{ product.featured_image.width }}"
          height="{{ product.featured_image.height }}"
        >
      </div>
    {%- endif -%}
    
    {%- comment -%}Product Info{%- endcomment -%}
    <div class="product-science-cta__info">
      <h3 class="product-science-cta__title">{{ product.title }}</h3>
      
      {%- if product.description != blank -%}
        <div class="product-science-cta__description">
          {{ product.description | strip_html | truncate: 150 }}
        </div>
      {%- endif -%}
      
      <div class="product-science-cta__price">
        {%- if product.compare_at_price > product.price -%}
          <span class="product-science-cta__price--sale">{{ product.price | money }}</span>
          <span class="product-science-cta__price--compare">{{ product.compare_at_price | money }}</span>
        {%- else -%}
          <span class="product-science-cta__price--regular">{{ product.price | money }}</span>
        {%- endif -%}
      </div>
      
      {%- comment -%}Add to Cart Form{%- endcomment -%}
      {%- if current_variant.available -%}
        <product-form class="product-science-cta__form">
          <form id="{{ product_form_id }}" action="/cart/add" method="post" enctype="multipart/form-data">
            <input type="hidden" name="id" value="{{ current_variant.id }}">
            <input type="hidden" name="quantity" value="1">
            
            <button
              type="submit"
              name="add"
              class="btn btn--primary btn--solid product-science-cta__button"
              {% unless current_variant.available %}disabled{% endunless %}
            >
              <span class="btn__text">
                {%- if current_variant.available -%}
                  {{ 'products.product.add_to_cart' | t }}
                {%- else -%}
                  {{ 'products.product.sold_out' | t }}
                {%- endif -%}
              </span>
            </button>
          </form>
        </product-form>
      {%- else -%}
        <button type="button" class="btn btn--primary btn--solid product-science-cta__button" disabled>
          <span class="btn__text">{{ 'products.product.sold_out' | t }}</span>
        </button>
      {%- endif -%}
    </div>
  </div>
  
  <style>
    .product-science-cta {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 20px;
      gap: 20px;
    }
    
    .product-science-cta__image {
      width: 100%;
      max-width: 400px;
    }
    
    .product-science-cta__image img {
      width: 100%;
      height: auto;
      object-fit: contain;
    }
    
    .product-science-cta__info {
      max-width: 600px;
    }
    
    .product-science-cta__title {
      font-size: 1.5rem;
      margin-bottom: 10px;
    }
    
    .product-science-cta__description {
      margin-bottom: 15px;
      line-height: 1.6;
    }
    
    .product-science-cta__price {
      font-size: 1.2rem;
      margin-bottom: 20px;
    }
    
    .product-science-cta__price--sale {
      color: var(--color-sale);
      font-weight: bold;
    }
    
    .product-science-cta__price--compare {
      text-decoration: line-through;
      opacity: 0.7;
      margin-left: 10px;
    }
    
    .product-science-cta__button {
      min-width: 200px;
    }
    
    @media (min-width: 750px) {
      .product-science-cta {
        flex-direction: row;
        text-align: left;
        gap: 40px;
      }
      
      .product-science-cta__image {
        flex: 0 0 40%;
      }
      
      .product-science-cta__info {
        flex: 1;
      }
    }
  </style>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('{{ product_form_id }}');
      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const button = form.querySelector('button[type="submit"]');
          const buttonText = button.querySelector('.btn__text');
          const originalText = buttonText.textContent;
          
          // Show loading state
          button.disabled = true;
          buttonText.textContent = '{{ "products.product.adding" | t | default: "Adding..." }}';
          
          // Submit the form via AJAX
          fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({
              id: form.querySelector('input[name="id"]').value,
              quantity: parseInt(form.querySelector('input[name="quantity"]').value)
            })
          })
          .then(response => response.json())
          .then(data => {
            // Success - update button
            buttonText.textContent = '{{ "products.product.added" | t | default: "Added!" }}';
            
            // Update cart count if cart drawer exists
            if (window.CartDrawer) {
              window.CartDrawer.refresh();
            }
            
            // Trigger cart update event
            document.dispatchEvent(new CustomEvent('cart:updated', { detail: data }));
            
            // Reset button after delay
            setTimeout(() => {
              button.disabled = false;
              buttonText.textContent = originalText;
            }, 2000);
          })
          .catch(error => {
            console.error('Error adding to cart:', error);
            button.disabled = false;
            buttonText.textContent = originalText;
            alert('{{ "products.product.error_adding" | t | default: "Error adding to cart. Please try again." }}');
          });
        });
      }
    });
  </script>
{%- else -%}
  <div class="product-science-cta product-science-cta--empty">
    <p>{{ 'products.general.no_product_selected' | t | default: 'No product selected' }}</p>
  </div>
{%- endif -%}