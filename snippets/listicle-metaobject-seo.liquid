{%- comment -%}
  SEO and metadata handling for metaobject-based listicle pages
  Usage: {% render 'listicle-metaobject-seo', listicle: listicle_data %}
{%- endcomment -%}

{%- liquid
  assign listicle = listicle | default: page.metafields.custom.listicle_content.value
  
  if listicle
    assign seo_title = listicle.seo_title | default: listicle.title
    assign seo_description = listicle.seo_description | default: page.excerpt
    assign canonical_url = shop.url | append: page.url
    assign author_name = listicle.author | default: 'BestSelf Team'
    assign publish_date = listicle.publish_date | default: page.created_at
    assign modified_date = page.updated_at
    assign listicle_items = listicle.listicle_items
  endif
-%}

{%- if listicle and listicle_items.size > 0 -%}
  {%- comment -%} Enhanced page title {%- endcomment -%}
  {%- if seo_title != page.title -%}
    <script>
      document.title = {{ seo_title | json }};
    </script>
  {%- endif -%}

  {%- comment -%} Meta tags {%- endcomment -%}
  {%- if seo_description != blank -%}
    <meta name="description" content="{{ seo_description | escape }}">
  {%- endif -%}
  
  <meta property="og:title" content="{{ seo_title | escape }}">
  <meta property="og:description" content="{{ seo_description | truncate: 160 | escape }}">
  <meta property="og:url" content="{{ canonical_url }}">
  <meta property="og:type" content="article">
  <meta property="article:author" content="{{ author_name | escape }}">
  <meta property="article:published_time" content="{{ publish_date | date: '%Y-%m-%d' }}">
  <meta property="article:modified_time" content="{{ modified_date | date: '%Y-%m-%d' }}">
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ seo_title | escape }}">
  <meta name="twitter:description" content="{{ seo_description | truncate: 160 | escape }}">

  {%- comment -%} Structured Data - HowTo Schema (appropriate for listicles) {%- endcomment -%}
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "HowTo",
      "name": {{ seo_title | json }},
      "description": {{ seo_description | json }},
      "author": {
        "@type": "Person",
        "name": {{ author_name | json }}
      },
      "datePublished": "{{ publish_date | date: '%Y-%m-%d' }}",
      "dateModified": "{{ modified_date | date: '%Y-%m-%d' }}",
      "publisher": {
        "@type": "Organization",
        "name": "BestSelf.co",
        "logo": {
          "@type": "ImageObject",
          "url": "{{ 'logo.png' | asset_url }}"
        }
      },
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": {{ canonical_url | json }}
      },
      "step": [
        {%- for item in listicle_items -%}
          {%- assign item_data = item.value -%}
          {%- if item_data.heading != blank and item_data.description != blank -%}
            {
              "@type": "HowToStep",
              "name": {{ item_data.heading | json }},
              "text": {{ item_data.description | strip_html | truncate: 300 | json }},
              "position": {{ item_data.number | default: forloop.index }},
              {%- if item_data.image != blank -%}
                "image": {
                  "@type": "ImageObject",
                  "url": {{ item_data.image | image_url: width: 800 | json }},
                  "width": "800",
                  "height": "600"
                },
              {%- endif -%}
              "url": "{{ canonical_url }}#listicle-item-{{ section.id }}-{{ forloop.index }}"
            }
            {%- unless forloop.last -%},{%- endunless -%}
          {%- endif -%}
        {%- endfor -%}
      ]
      {%- if listicle.featured_products.size > 0 -%}
        ,
        "mentions": [
          {%- for product in listicle.featured_products limit: 3 -%}
            {
              "@type": "Product",
              "name": {{ product.title | json }},
              "url": "{{ shop.url }}{{ product.url }}",
              "description": {{ product.description | strip_html | truncate: 160 | json }}
              {%- if product.featured_media -%},
                "image": {{ product.featured_media | image_url: width: 600 | json }}
              {%- endif -%}
            }
            {%- unless forloop.last -%},{%- endunless -%}
          {%- endfor -%}
        ]
      {%- endif -%}
    }
  </script>

  {%- comment -%} Article structured data as backup {%- endcomment -%}
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Article",
      "headline": {{ seo_title | json }},
      "description": {{ seo_description | json }},
      "author": {
        "@type": "Person",
        "name": {{ author_name | json }}
      },
      "datePublished": "{{ publish_date | date: '%Y-%m-%d' }}",
      "dateModified": "{{ modified_date | date: '%Y-%m-%d' }}",
      "publisher": {
        "@type": "Organization",
        "name": "BestSelf.co",
        "logo": {
          "@type": "ImageObject",
          "url": "{{ 'logo.png' | asset_url }}"
        }
      },
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": {{ canonical_url | json }}
      },
      "wordCount": {{ listicle_items.size | times: 150 }},
      "articleSection": "Productivity",
      "articleBody": "{{ listicle_items | map: 'value' | map: 'description' | join: ' ' | strip_html | truncate: 500 }}"
    }
  </script>
{%- endif -%}